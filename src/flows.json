[{"id":"b34bae19.14a5d","type":"tab","label":"Node-RED Server","disabled":false,"info":""},{"id":"c340aff3.7dec58","type":"mqtt-broker","z":"","name":"Mosca","broker":"localhost","port":"1884","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"c8c9625e.670fc","type":"mqtt-broker","z":"","name":"CloudMQTT","broker":"m24.cloudmqtt.com","port":"15946","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","willTopic":"","willQos":"0","willRetain":"false","willPayload":""},{"id":"9e7b3ced.243e9","type":"debug","z":"b34bae19.14a5d","name":"","active":false,"tosidebar":true,"console":false,"complete":"false","x":1010,"y":180,"wires":[]},{"id":"7f6d9692.bde57","type":"mqtt in","z":"b34bae19.14a5d","name":"","topic":"smartlock/test","qos":"0","broker":"c8c9625e.670fc","x":150,"y":180,"wires":[["db85c3e3.dd5808"]]},{"id":"db85c3e3.dd5808","type":"json","z":"b34bae19.14a5d","name":"","property":"payload","action":"","pretty":false,"x":310,"y":180,"wires":[["48b56bb6.94cd44"]]},{"id":"48b56bb6.94cd44","type":"function","z":"b34bae19.14a5d","name":"Rx Data extract","func":"if (msg.payload.cmd == \"rx\") {\n    msg.payload = msg.payload.data;\n} else {\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":180,"wires":[["237ab9a7.8ff2de"]]},{"id":"237ab9a7.8ff2de","type":"function","z":"b34bae19.14a5d","name":"Hex 2 string","func":"function hex2a(hexx) {\n    var hex = hexx.toString();//force conversion\n    var str = '';\n    for (var i = 0; (i < hex.length && hex.substr(i, 2) !== '00'); i += 2)\n        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n    return str;\n}\n\nmsg.payload = hex2a(msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":180,"wires":[["5e451e8b.804ad"]]},{"id":"6b13a1d7.5c223","type":"http in","z":"b34bae19.14a5d","name":"Unlock API","url":"/unlock","method":"get","upload":false,"swaggerDoc":"","x":140,"y":380,"wires":[["3ff45251.6be00e"]]},{"id":"2a3206b7.ceff9a","type":"http response","z":"b34bae19.14a5d","name":"HTTPS","statusCode":"","headers":{},"x":700,"y":380,"wires":[]},{"id":"3ff45251.6be00e","type":"function","z":"b34bae19.14a5d","name":"Pass psw","func":"if (msg.payload.smartlockID == global.get('pass')) {\n    msg.payload = global.get('psw');\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":380,"wires":[["2a3206b7.ceff9a","9e7b3ced.243e9"]]},{"id":"5e451e8b.804ad","type":"function","z":"b34bae19.14a5d","name":"store psw","func":"global.set('psw', msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":180,"wires":[["9e7b3ced.243e9"]]},{"id":"ffc0c6ce.1c69a8","type":"http in","z":"b34bae19.14a5d","name":"Set password API","url":"/pass","method":"get","upload":false,"swaggerDoc":"","x":170,"y":540,"wires":[["70f8da23.1b7244"]]},{"id":"9e7e1984.d4a058","type":"http response","z":"b34bae19.14a5d","name":"","statusCode":"","headers":{},"x":670,"y":540,"wires":[]},{"id":"70f8da23.1b7244","type":"function","z":"b34bae19.14a5d","name":"Pass pass","func":"global.set('pass', msg.payload.pass)\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":540,"wires":[["9e7e1984.d4a058","9e7b3ced.243e9"]]},{"id":"19283dab.f13d82","type":"comment","z":"b34bae19.14a5d","name":"Output from Teracom Lora Server","info":"","x":210,"y":120,"wires":[]},{"id":"d6f0299d.230fe8","type":"comment","z":"b34bae19.14a5d","name":"Parse JSON","info":"","x":290,"y":240,"wires":[]},{"id":"ab53019d.7488c","type":"comment","z":"b34bae19.14a5d","name":"Extract RX data from JSON","info":"","x":480,"y":120,"wires":[]},{"id":"5b85544b.197114","type":"comment","z":"b34bae19.14a5d","name":"Convert HEX to STRING","info":"","x":670,"y":240,"wires":[]},{"id":"e59f0ff1.82851","type":"comment","z":"b34bae19.14a5d","name":"Store psw in global variable","info":"","x":840,"y":120,"wires":[]},{"id":"ada4d2dd.128da8","type":"comment","z":"b34bae19.14a5d","name":"Output psw to debug (deactivated)","info":"","x":1060,"y":240,"wires":[]},{"id":"f7ad5a3e.6789f8","type":"comment","z":"b34bae19.14a5d","name":"Unlock API to allow web-app to GET psw if password is correct","info":"","x":310,"y":340,"wires":[]},{"id":"359d4daa.d550d2","type":"comment","z":"b34bae19.14a5d","name":"Create GET access point","info":"","x":190,"y":420,"wires":[]},{"id":"5353967.1f738e8","type":"comment","z":"b34bae19.14a5d","name":"Expose psw if password is correct","info":"","x":460,"y":420,"wires":[]},{"id":"f21d3b4e.623e4","type":"comment","z":"b34bae19.14a5d","name":"Create HTTPS access point","info":"","x":740,"y":420,"wires":[]},{"id":"ef14acab.47f0c","type":"comment","z":"b34bae19.14a5d","name":"API to allow web-app to set new password","info":"","x":240,"y":500,"wires":[]},{"id":"996a3443.22e43","type":"comment","z":"b34bae19.14a5d","name":"Create GET access point","info":"","x":190,"y":580,"wires":[]},{"id":"bf3021e2.3bd76","type":"comment","z":"b34bae19.14a5d","name":"Create HTTPS access point","info":"","x":740,"y":580,"wires":[]},{"id":"a592fd74.eb7a8","type":"comment","z":"b34bae19.14a5d","name":"Store send password","info":"","x":440,"y":580,"wires":[]},{"id":"a86d4259.38cf5","type":"comment","z":"b34bae19.14a5d","name":"Note: psw is \"hidden password\", and pass is \"public password\"","info":"","x":1150,"y":320,"wires":[]},{"id":"a9de3079.9c0c8","type":"comment","z":"b34bae19.14a5d","name":"psw is never exposed to the user","info":"","x":1050,"y":360,"wires":[]},{"id":"c049d63b.1fa48","type":"comment","z":"b34bae19.14a5d","name":"pass is the shared password between user and owner","info":"","x":1120,"y":400,"wires":[]}]